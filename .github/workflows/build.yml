name: Build Game Updater Executables

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: [3.11]

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 4. Build executables
      - name: Build executables
        run: |
          cd scripts
          rm -rf dist build __pycache__  # Clean previous builds
          for f in *.py; do
            echo "Building $f"
            if [[ "$RUNNER_OS" == "Windows" ]]; then
              pyinstaller --onefile --noconsole "$f"
            else
              pyinstaller --onefile "$f"
            fi
          done

      # 5. Zip executables per OS
      - name: Package executables
        run: |
          cd scripts/dist
          OS_NAME="${{ matrix.os }}"
          if [[ "$OS_NAME" == "windows-latest" ]]; then
            zip -r ../../windows_build.zip ./*
          elif [[ "$OS_NAME" == "ubuntu-latest" ]]; then
            zip -r ../../linux_build.zip ./*
          elif [[ "$OS_NAME" == "macos-latest" ]]; then
            zip -r ../../macos_build.zip ./*
          fi

      # 6. Upload zip files as artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: game-updater-${{ matrix.os }}
          path: |
            windows_build.zip
            linux_build.zip
            macos_build.zip
